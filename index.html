<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Namma Metro ‚Äì Map & Route Finder</title>
  <style>
    :root {
      --purple: #6a1b9a;
      --green: #2e7d32;
      --pink: #d81b60;
      --bg: #080816;
      --card: #111827;
      --card-soft: #0b1020;
      --border: #1f2937;
      --accent: #38bdf8;
      --text-main: #e5e7eb;
      --text-soft: #9ca3af;
      --interchange: #facc15;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      background: radial-gradient(circle at top, #111827, #020617 60%);
      color: var(--text-main);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      padding: 16px 24px;
      border-bottom: 1px solid var(--border);
      background: linear-gradient(90deg, #020617, #020617cc, #020617);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    header h1 {
      margin: 0;
      font-size: 1.2rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--accent);
    }

    header span {
      font-size: 0.8rem;
      color: var(--text-soft);
    }

    main {
      flex: 1;
      display: grid;
      grid-template-columns: minmax(360px, 55%) minmax(320px, 1fr);
      gap: 16px;
      padding: 16px;
    }

    @media (max-width: 900px) {
      main { grid-template-columns: 1fr; }
    }

    .card {
      background: radial-gradient(circle at top left, #111827, #020617);
      border-radius: 18px;
      border: 1px solid var(--border);
      padding: 16px;
      box-shadow: 0 18px 40px rgba(0,0,0,0.6);
    }

    .map-panel { display: flex; flex-direction: column; min-height: 400px; }

    .map-tabs {
      display: inline-flex;
      background: var(--card-soft);
      border-radius: 999px;
      padding: 4px;
      margin-bottom: 12px;
    }

    .map-tabs button {
      flex: 1;
      border-radius: 999px;
      border: none;
      padding: 6px 14px;
      font-size: 0.85rem;
      cursor: pointer;
      background: transparent;
      color: var(--text-soft);
      transition: background 0.15s ease, color 0.15s ease;
    }

    .map-tabs button.active {
      background: #020617;
      color: var(--accent);
      box-shadow: 0 0 0 1px #0f172a;
    }

    .map-view {
      display: none;
      margin-top: 4px;
      border-radius: 16px;
      background: #020617;
      border: 1px solid #0b1220;
      padding: 14px;
      height: 100%;
      overflow: auto;
    }

    .map-view.active { display: block; }

    .map-legend {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 12px;
      font-size: 0.78rem;
      color: var(--text-soft);
    }

    .legend-item {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 8px;
      border-radius: 999px;
      background: #020617;
      border: 1px solid #111827;
    }

    .legend-swatch {
      width: 10px;
      height: 10px;
      border-radius: 999px;
    }

    .legend-swatch.purple { background: var(--purple); }
    .legend-swatch.green { background: var(--green); }
    .legend-swatch.pink  { background: var(--pink); }

    .map-lines {
      display: grid;
      grid-template-columns: repeat(3, minmax(150px, 1fr));
      gap: 16px;
      align-items: flex-start;
    }

    @media (max-width: 720px) {
      .map-lines { grid-template-columns: 1fr; }
    }

    .line-column {
      padding: 10px 10px 10px 6px;
      border-radius: 14px;
      background: #020617;
      border: 1px solid #0b1220;
      max-height: 420px;
      overflow-y: auto;
    }

    .line-header {
      font-size: 0.9rem;
      font-weight: 600;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .line-header .pill {
      width: 32px;
      height: 6px;
      border-radius: 999px;
    }

    .line-column.purple .pill { background: var(--purple); }
    .line-column.green  .pill { background: var(--green); }
    .line-column.pink   .pill { background: var(--pink); }

    .station-node {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 4px 0;
      font-size: 0.78rem;
      position: relative;
    }

    .station-dot {
      width: 10px;
      height: 10px;
      border-radius: 999px;
      flex-shrink: 0;
      border: 2px solid #020617;
      box-shadow: 0 0 0 1px #020617;
      opacity: 0.8;
      transition: transform 0.15s ease, opacity 0.15s ease, box-shadow 0.15s ease;
    }

    .purple .station-dot { background: var(--purple); }
    .green  .station-dot { background: var(--green); }
    .pink   .station-dot { background: var(--pink); }

    .station-label {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      color: var(--text-soft);
    }

    .station-dot.in-route {
      opacity: 1;
      transform: scale(1.2);
      box-shadow: 0 0 0 1px var(--interchange);
    }

    .station-label.in-route {
      color: #f9fafb;
      font-weight: 600;
    }

    /* SELECTED ROUTE MAP (Option A + gradient, yellow interchanges) */

    .route-strip {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
      font-size: 0.8rem;
    }

    .route-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      background: linear-gradient(135deg, #1d2440, #0b1120);
      border: 1px solid #1f2937;
      box-shadow: 0 6px 14px rgba(15,23,42,0.7);
      white-space: nowrap;
    }

    .route-pill-label {
      color: #e5e7eb;
    }

    .route-bullet {
      width: 9px;
      height: 9px;
      border-radius: 999px;
      background: #4b5563;
      box-shadow: 0 0 0 2px #020617;
      flex-shrink: 0;
    }

    .route-bullet.interchange {
      background: var(--interchange);
      box-shadow: 0 0 6px rgba(250,204,21,0.9);
    }

    .route-arrow {
      font-size: 0.8rem;
      opacity: 0.7;
    }

    .controls-panel {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .controls-panel h2 {
      margin: 0 0 4px;
      font-size: 1rem;
    }

    .field-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }

    @media (max-width: 500px) {
      .field-row { grid-template-columns: 1fr; }
    }

    label {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 0.78rem;
      color: var(--text-soft);
    }

    select {
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid #1f2937;
      background: #020617;
      color: var(--text-main);
      font-size: 0.8rem;
      outline: none;
    }

    select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px #0ea5e9;
    }

    .buttons-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 4px;
    }

    button {
      cursor: pointer;
      border-radius: 999px;
      padding: 6px 12px;
      border: 1px solid transparent;
      font-size: 0.8rem;
      background: #0f172a;
      color: var(--text-main);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: background 0.15s ease, transform 0.1s ease, box-shadow 0.15s ease, border-color 0.15s ease;
    }

    button.primary {
      background: linear-gradient(135deg, #22c55e, #16a34a);
      border-color: #16a34a;
      box-shadow: 0 12px 25px rgba(22,163,74,0.4);
    }

    button.secondary {
      background: #020617;
      border-color: #1f2937;
    }

    button.ghost {
      background: transparent;
      border-color: #1f2937;
      color: var(--text-soft);
    }

    button:active {
      transform: translateY(1px);
      box-shadow: none;
    }

    .icon { font-size: 0.9rem; }

    .route-summary {
      margin-top: 8px;
      padding: 10px;
      border-radius: 12px;
      background: #020617;
      border: 1px solid #0b1220;
      font-size: 0.8rem;
      color: var(--text-soft);
      font-family: "JetBrains Mono", "Fira Code", ui-monospace, SFMono-Regular,
        Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      white-space: pre-wrap;
    }

    .route-summary-title {
      color: var(--accent);
      font-weight: 600;
      margin-bottom: 6px;
      display: block;
    }

    .muted {
      color: var(--text-soft);
      font-size: 0.78rem;
      margin-top: 2px;
    }

    .pill-inline {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid #1f2937;
      background: #020617;
      font-size: 0.7rem;
      margin-left: 4px;
    }
  </style>
</head>
<body>
  <header>
    <h1>Namma Metro ‚Äì Interactive Map & Route</h1>
    <span>Purple ¬∑ Green ¬∑ Pink ¬∑ Distance ¬∑ Time ¬∑ Fare est.</span>
  </header>

  <main>
    <!-- LEFT: MAPS -->
    <section class="card map-panel">
      <div class="map-tabs">
        <button class="active" data-map-tab="full">Full Metro Map</button>
        <button data-map-tab="selected">Selected Route Map</button>
      </div>

      <div class="map-view active" id="fullMap">
        <div class="map-legend">
          <div class="legend-item">
            <span class="legend-swatch purple"></span> Purple Line
          </div>
          <div class="legend-item">
            <span class="legend-swatch green"></span> Green Line
          </div>
          <div class="legend-item">
            <span class="legend-swatch pink"></span> Pink Line
          </div>
          <div class="legend-item">
            <span style="font-size:0.7rem;">‚óè</span> Station
          </div>
        </div>
        <div id="fullMapLines" class="map-lines"></div>
      </div>

      <div class="map-view" id="selectedMap">
        <p class="muted" id="selectedMapHint">
          Once you find a route, the selected path will appear here as gradient
          pills. Yellow dots indicate interchange stations.
        </p>
        <div id="selectedRouteStrip" class="route-strip"></div>
      </div>
    </section>

    <!-- RIGHT: CONTROLS + OUTPUT -->
    <section class="card controls-panel">
      <div>
        <h2>Select Stations</h2>
        <p class="muted">
          Choose <strong>From</strong> and <strong>To</strong> stations ‚Äì route will
          automatically consider interchanges (Majestic, MG Road, etc.).
        </p>
      </div>

      <div class="field-row">
        <label>
          From station
          <select id="fromStation">
            <option value="">‚Äî Select starting station ‚Äî</option>
          </select>
        </label>
        <label>
          To station
          <select id="toStation">
            <option value="">‚Äî Select destination station ‚Äî</option>
          </select>
        </label>
      </div>

      <div class="buttons-row">
        <button id="findRouteBtn" class="primary">
          <span class="icon">üß≠</span>
          Find Route
        </button>
        <button id="clearBtn" class="secondary">
          <span class="icon">‚ôªÔ∏è</span>
          Clear
        </button>
        <button id="downloadHtmlBtn" class="ghost">
          <span class="icon">‚¨áÔ∏è</span>
          Download Route (HTML)
        </button>
      </div>

      <div class="route-summary" id="routeSummary">
<span class="route-summary-title">Namma Metro ‚Äî Route Summary</span>
No route calculated yet. Pick stations and click "Find Route".
      </div>

      <p class="muted">
        Note: Distance, time, and fare are <strong>approximate demo estimates</strong>
        using assumed values (km per station, average speed, and simple fare formula)
        for academic/project use.
      </p>
    </section>
  </main>

  <script>
    // --- PARAMETERS FOR ESTIMATES -----------------------------------------
    const DIST_PER_HOP_KM = 1.1;          // per station gap (tune to match C)
    const AVG_SPEED_KMPH = 28;            // average running speed
    const INTERCHANGE_BUFFER_MIN = 5;     // extra minutes per interchange

    function estimateFare(distanceKm) {
      const base = 10;
      const variable = distanceKm * 2.5;
      let fare = base + variable;
      fare = Math.round(fare / 5) * 5;
      if (fare < 10) fare = 10;
      return fare;
    }

    // --- DATA: STATIONS PER LINE ------------------------------------------

    const purpleLine = [
      "Challaghatta",
      "Kengeri",
      "Kengeri Bus Terminal",
      "Pattanagere",
      "Jnanabharathi",
      "Rajarajeshwari Nagar",
      "Nayandahalli",
      "Mysuru Road",
      "Deepanjali Nagar",
      "Attiguppe",
      "Vijayanagar",
      "Hosahalli",
      "Magadi Road",
      "Nadaprabhu Kempegowda Stn., Majestic",
      "Sir M. Visveshwaraya Stn., Central College",
      "Dr. B.R. Ambedkar Station, Vidhana Soudha",
      "Cubbon Park",
      "Mahatma Gandhi Road",
      "Trinity",
      "Halasuru",
      "Indiranagar",
      "Swami Vivekananda Road",
      "Baiyappanahalli",
      "Benniganahalli",
      "Krishnarajapura",
      "Singayyanapalya",
      "Garudacharpalya",
      "Hoodi",
      "Seetharampalya",
      "Kundalahalli",
      "Nallurhalli",
      "Sri Sathya Sai Hospital",
      "Pattandur Agrahara",
      "Kadugodi Tree Park",
      "Hopefarm Channasandra",
      "Whitefield (Kadugodi)"
    ];

    const greenLine = [
      "Madavara",
      "Chikkabidarakallu",
      "Manjunath Nagar",
      "Nagasandra",
      "Dasarahalli",
      "Jalahalli",
      "Peenya Industry",
      "Peenya",
      "Goraguntepalya",
      "Yeshwanthpur",
      "Sandal Soap Factory",
      "Mahalakshmi",
      "Rajajinagar",
      "Mahakavi Kuvempu Road",
      "Srirampura",
      "Mantri Square Sampige Road",
      "Nadaprabhu Kempegowda Stn., Majestic",
      "Chickpete",
      "Krishna Rajendra Market",
      "National College",
      "Lalbagh",
      "South End Circle",
      "Jayanagar",
      "Rashtreeya Vidyalaya Road",
      "Banashankari",
      "Jaya Prakash Nagar",
      "Yelachenahalli",
      "Konankunte Cross",
      "Doddakallasandra",
      "Vajarahalli",
      "Thalaghattapura",
      "Silk Institute"
    ];

    const pinkLine = [
      "Kalena Agrahara",
      "Hulimavu",
      "IIM-Bangalore",
      "JP Nagar 4th Phase",
      "Jayadeva Hospital",
      "Swagath Road Cross",
      "Dairy Circle",
      "Lakkasandra",
      "Langford Town",
      "Rashtriya Military School",
      "Mahatma Gandhi Road",
      "Shivajinagar",
      "Cantonment",
      "Pottery Town",
      "Tannery Road",
      "Venkateshpura",
      "Kadugundanahalli",
      "Nagawara"
    ];

    const lines = { purple: purpleLine, green: greenLine, pink: pinkLine };

    const lineNamesPretty = {
      purple: "Purple",
      green: "Green",
      pink: "Pink"
    };

    // --- GRAPH BUILDING (BFS) ---------------------------------------------

    const graph = {};
    const stationLines = {}; // station -> Set(line names)

    function addEdge(a, b) {
      if (!graph[a]) graph[a] = new Set();
      if (!graph[b]) graph[b] = new Set();
      graph[a].add(b);
      graph[b].add(a);
    }

    function buildGraph() {
      for (const [lineName, stations] of Object.entries(lines)) {
        stations.forEach((s, idx) => {
          if (!graph[s]) graph[s] = new Set();
          if (!stationLines[s]) stationLines[s] = new Set();
          stationLines[s].add(lineName);

          if (idx > 0) {
            const prev = stations[idx - 1];
            addEdge(s, prev);
          }
        });
      }
    }

    function bfsShortestPath(start, end) {
      if (start === end) return [start];
      if (!graph[start] || !graph[end]) return null;

      const queue = [start];
      const visited = new Set([start]);
      const parent = {};

      while (queue.length > 0) {
        const node = queue.shift();
        for (const next of graph[node]) {
          if (!visited.has(next)) {
            visited.add(next);
            parent[next] = node;
            if (next === end) {
              const path = [end];
              let cur = end;
              while (cur !== start) {
                cur = parent[cur];
                path.push(cur);
              }
              return path.reverse();
            }
            queue.push(next);
          }
        }
      }
      return null;
    }

    // --- UI HELPERS -------------------------------------------------------

    function populateStationDropdowns() {
      const allStations = new Set();
      Object.values(lines).forEach(arr => arr.forEach(s => allStations.add(s)));
      const sorted = Array.from(allStations).sort((a, b) =>
        a.localeCompare(b, "en", { sensitivity: "base" })
      );

      const fromSel = document.getElementById("fromStation");
      const toSel = document.getElementById("toStation");

      sorted.forEach(name => {
        const opt1 = document.createElement("option");
        opt1.value = name;
        opt1.textContent = name;
        fromSel.appendChild(opt1);

        const opt2 = document.createElement("option");
        opt2.value = name;
        opt2.textContent = name;
        toSel.appendChild(opt2);
      });
    }

    function renderFullMap() {
      const container = document.getElementById("fullMapLines");
      container.innerHTML = "";

      for (const [lineName, stations] of Object.entries(lines)) {
        const col = document.createElement("div");
        col.className = "line-column " + lineName;

        const header = document.createElement("div");
        header.className = "line-header";
        const pill = document.createElement("div");
        pill.className = "pill";
        const title = document.createElement("span");
        title.textContent = lineNamesPretty[lineName] + " Line";

        header.appendChild(pill);
        header.appendChild(title);
        col.appendChild(header);

        stations.forEach(station => {
          const node = document.createElement("div");
          node.className = "station-node";

          const dot = document.createElement("div");
          dot.className = "station-dot";
          dot.dataset.station = station;

          const label = document.createElement("div");
          label.className = "station-label";
          label.textContent = station;
          label.dataset.station = station;

          node.appendChild(dot);
          node.appendChild(label);
          col.appendChild(node);
        });

        container.appendChild(col);
      }
    }

    function clearRouteHighlight() {
      document
        .querySelectorAll(".station-dot.in-route, .station-label.in-route")
        .forEach(el => el.classList.remove("in-route"));
    }

    function highlightRouteOnMap(route) {
      const inRoute = new Set(route);
      document.querySelectorAll(".station-dot, .station-label").forEach(el => {
        const s = el.dataset.station;
        if (inRoute.has(s)) el.classList.add("in-route");
        else el.classList.remove("in-route");
      });
    }

    function renderSelectedRouteStrip(route, interchangesSet) {
      const hint = document.getElementById("selectedMapHint");
      const strip = document.getElementById("selectedRouteStrip");
      strip.innerHTML = "";

      if (!route || route.length === 0) {
        hint.style.display = "block";
        return;
      }

      hint.style.display = "none";

      route.forEach((station, idx) => {
        if (idx > 0) {
          const arrow = document.createElement("span");
          arrow.className = "route-arrow";
          arrow.textContent = "‚ûù";
          strip.appendChild(arrow);
        }

        const pill = document.createElement("div");
        pill.className = "route-pill";

        const bullet = document.createElement("div");
        bullet.className = "route-bullet";
        if (interchangesSet.has(station)) {
          bullet.classList.add("interchange");
        }

        const label = document.createElement("span");
        label.className = "route-pill-label";
        label.textContent = station;

        pill.appendChild(bullet);
        pill.appendChild(label);
        strip.appendChild(pill);
      });
    }

    // --- SEGMENTS / INTERCHANGES / STATS ----------------------------------

    function linesForStation(station) {
      const set = stationLines[station];
      return set ? Array.from(set) : [];
    }

    function pickLineBetween(a, b) {
      const la = linesForStation(a);
      const lb = linesForStation(b);
      const common = la.filter(x => lb.includes(x));
      return common[0] || la[0] || lb[0] || null;
    }

    function computeRouteStats(route) {
      if (!route || route.length < 2) {
        return {
          segments: [],
          interchanges: [],
          mainLine: null,
          distanceKm: 0,
          travelMinutes: 0,
          totalMinutes: 0,
          fareRs: 0
        };
      }

      let currentLine = null;
      let segments = [];
      let segmentStartIndex = 0;
      const interchanges = [];

      for (let i = 0; i < route.length - 1; i++) {
        const a = route[i];
        const b = route[i + 1];
        const segmentLine = pickLineBetween(a, b);

        if (!currentLine) {
          currentLine = segmentLine;
          segmentStartIndex = i;
        } else if (segmentLine !== currentLine) {
          const from = route[segmentStartIndex];
          const to = route[i];
          const stops = i - segmentStartIndex + 1;
          segments.push({ line: currentLine, from, to, stops });
          interchanges.push(route[i]); // interchange station
          currentLine = segmentLine;
          segmentStartIndex = i;
        }
      }

      const fromLast = route[segmentStartIndex];
      const toLast = route[route.length - 1];
      const stopsLast = route.length - 1 - segmentStartIndex + 1;
      segments.push({ line: currentLine, from: fromLast, to: toLast, stops: stopsLast });

      const hops = route.length - 1;
      const distanceKm = hops * DIST_PER_HOP_KM;
      const travelMinutes = (distanceKm / AVG_SPEED_KMPH) * 60;
      const interchangeBuffer = interchanges.length * INTERCHANGE_BUFFER_MIN;
      const totalMinutes = travelMinutes + interchangeBuffer;
      const fareRs = estimateFare(distanceKm);
      const mainLine = segments[0]?.line || null;

      return {
        segments,
        interchanges,
        mainLine,
        distanceKm,
        travelMinutes,
        totalMinutes,
        fareRs
      };
    }

    function interchangesWithLines(interchanges) {
      return interchanges.map(st => {
        const ls = linesForStation(st).map(l => lineNamesPretty[l]).join(", ");
        return `${st} (${ls})`;
      });
    }

    // --- ROUTE + DOWNLOAD LOGIC ------------------------------------------

    let lastRoute = null;
    let lastFrom = null;
    let lastTo = null;
    let lastStats = null;

    function formatSummaryText(from, to, route, stats) {
      const hops = route.length - 1;
      const distanceStr = stats.distanceKm.toFixed(2);
      const runTimeStr = stats.travelMinutes.toFixed(0);
      const totalTimeStr = stats.totalMinutes.toFixed(0);
      const segLines = stats.segments
        .filter(seg => seg.line)
        .map(seg => {
          const label = lineNamesPretty[seg.line];
          return ` - Line ${label.toLowerCase()}: ${seg.from.toLowerCase()} -> ${seg.to.toLowerCase()} (${seg.stops} stops)`;
        })
        .join("\n");

      const interLines = interchangesWithLines(stats.interchanges)
        .map(s => ` - ${s.toLowerCase()}`)
        .join("\n") || " - none (direct line)";

      return (
`Namma Metro ‚Äî Route Summary

From: ${from.toLowerCase()}
To:   ${to.toLowerCase()}

Route:
${route.map(s => s.toLowerCase()).join(" -> ")}

Segments by line:
${segLines || " - (not available)"}

Interchanges:
${interLines}

Summary:
 - Total stops: ${route.length}
 - Distance   : ${distanceStr} km
 - Time       : ${totalTimeStr} min (incl. interchange buffer)
 - Fare est.  : Rs ${stats.fareRs}`
      );
    }

    function onFindRoute() {
      const from = document.getElementById("fromStation").value;
      const to = document.getElementById("toStation").value;
      const summary = document.getElementById("routeSummary");

      if (!from || !to) {
        summary.textContent =
`Namma Metro ‚Äî Route Summary

Please select both "From" and "To" stations.`;
        lastRoute = null;
        lastFrom = lastTo = null;
        lastStats = null;
        clearRouteHighlight();
        renderSelectedRouteStrip(null, new Set());
        return;
      }

      const route = bfsShortestPath(from, to);
      if (!route) {
        summary.textContent =
`Namma Metro ‚Äî Route Summary

No route found between:
From: ${from}
To  : ${to}`;
        lastRoute = null;
        lastFrom = lastTo = null;
        lastStats = null;
        clearRouteHighlight();
        renderSelectedRouteStrip(null, new Set());
        return;
      }

      lastRoute = route;
      lastFrom = from;
      lastTo = to;
      lastStats = computeRouteStats(route);

      highlightRouteOnMap(route);
      const interSet = new Set(lastStats.interchanges);
      renderSelectedRouteStrip(route, interSet);

      summary.textContent = formatSummaryText(from, to, route, lastStats);

      switchTab("selected");
    }

    function onClear() {
      document.getElementById("fromStation").value = "";
      document.getElementById("toStation").value = "";
      lastRoute = null;
      lastFrom = lastTo = null;
      lastStats = null;
      clearRouteHighlight();
      renderSelectedRouteStrip(null, new Set());
      document.getElementById("routeSummary").textContent =
`Namma Metro ‚Äî Route Summary

Cleared. Choose stations and click "Find Route" again.`;
    }

    function onDownloadHtml() {
      if (!lastRoute || !lastFrom || !lastTo || !lastStats) {
        alert("First find a route, then you can download the HTML report.");
        return;
      }

      const title = "Namma Metro Route Summary";
      const now = new Date();
      const dateStr = now.toLocaleString();
      const stats = lastStats;
      const textSummary = formatSummaryText(lastFrom, lastTo, lastRoute, stats);

      const safe = text =>
        text.replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;");

      const html = `<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>${safe(title)}</title>
<style>
body {
  font-family: "JetBrains Mono", ui-monospace, SFMono-Regular, Menlo, Monaco,
               Consolas, "Liberation Mono", "Courier New", monospace;
  margin: 24px;
  background:#0b1120;
  color:#e5e7eb;
  white-space: pre-wrap;
}
h1 { font-size: 1.4rem; color:#38bdf8; margin-bottom:4px; }
small { color:#9ca3af; font-size:0.85rem; }
.codebox {
  margin-top:16px;
  padding:12px 14px;
  border-radius:10px;
  background:#020617;
  border:1px solid #1f2937;
}
</style>
</head>
<body>
<h1>${safe(title)}</h1>
<small>Generated on ${safe(dateStr)}</small>
<div class="codebox">
${safe(textSummary)}
</div>
</body>
</html>`;

      const blob = new Blob([html], { type: "text/html" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      const fromSafe = lastFrom.replace(/[^a-z0-9]+/gi, "_");
      const toSafe = lastTo.replace(/[^a-z0-9]+/gi, "_");
      a.download = `namma_metro_route_${fromSafe}_to_${toSafe}.html`;
      a.href = url;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    // --- TABS -------------------------------------------------------------

    function switchTab(tab) {
      document
        .querySelectorAll(".map-tabs button")
        .forEach(btn =>
          btn.classList.toggle("active", btn.dataset.mapTab === tab)
        );

      document
        .querySelectorAll(".map-view")
        .forEach(view => {
          view.classList.toggle(
            "active",
            (tab === "full" && view.id === "fullMap") ||
            (tab === "selected" && view.id === "selectedMap")
          );
        });
    }

    function initTabs() {
      document
        .querySelectorAll(".map-tabs button")
        .forEach(btn => {
          btn.addEventListener("click", () => {
            const tab = btn.dataset.mapTab;
            switchTab(tab);
          });
        });
    }

    // --- INIT -------------------------------------------------------------

    document.addEventListener("DOMContentLoaded", () => {
      buildGraph();
      populateStationDropdowns();
      renderFullMap();
      initTabs();

      document
        .getElementById("findRouteBtn")
        .addEventListener("click", onFindRoute);
      document
        .getElementById("clearBtn")
        .addEventListener("click", onClear);
      document
        .getElementById("downloadHtmlBtn")
        .addEventListener("click", onDownloadHtml);
    });
  </script>
</body>
</html>
